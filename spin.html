<!DOCTYPE html>  <html lang="en">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
  <title>CashPrint - Spin to Win</title>  
  <style>  
    body {  
      font-family: Arial, sans-serif;  
      background: #f9f9f9;  
      padding: 20px;  
      text-align: center;  
    }  
    h1 { color: #d35400; }  
    input, button {  
      padding: 10px;  
      margin: 10px;  
      font-size: 16px;  
    }  
    #wheel {  
      width: 200px;  
      height: 200px;  
      margin: 20px auto;  
      border: 10px solid #d35400;  
      border-radius: 50%;  
      border-top-color: transparent;  
    }  
    .spin { animation: spin 1.2s ease-out; }  
    @keyframes spin {  
      0% { transform: rotate(0deg); }  
      100% { transform: rotate(720deg); }  
    }  
    #winnerList {  
      margin-top: 20px;  
      text-align: left;  
      padding: 10px;  
      background: #fff;  
      border-radius: 8px;  
      max-width: 400px;  
      margin-left: auto;  
      margin-right: auto;  
      box-shadow: 0 0 10px rgba(0,0,0,0.1);  
    }  
    #winnerList p {  
      margin: 5px 0;  
      font-size: 15px;  
    }  
  </style>  
</head>  
<body>  
  <h1>Spin to Win</h1>  
  <p>Enter the password shared in the WhatsApp group:</p>  
  <input type="text" id="passwordInput" placeholder="Enter spin password" />  
  <button onclick="submitSpin()">Spin Now</button>  
  <div id="wheel"></div>  
  <div id="message"></div>    <h3>Latest Winners</h3>  
  <div id="winnerList">Loading...</div>    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>    <script>  
    const firebaseConfig = {  
      apiKey: "AIzaSyDIP5I-yG0skjsva9B3p-pMshPuq4odFU8",  
      authDomain: "cashprint-c5e72.firebaseapp.com",  
      projectId: "cashprint-c5e72",  
      storageBucket: "cashprint-c5e72.appspot.com",  
      messagingSenderId: "613734624925",  
      appId: "1:613734624925:web:d6bc8a18b3b6cb3a31ae74"  
    };  
    firebase.initializeApp(firebaseConfig);  
    const auth = firebase.auth();  
    const db = firebase.firestore();  
  
    const passwordInput = document.getElementById("passwordInput");  
    const message = document.getElementById("message");  
    const wheel = document.getElementById("wheel");  
    const winnerList = document.getElementById("winnerList");  
  
    async function submitSpin() {  
      message.textContent = "";  
      wheel.classList.remove("spin");  
  
      const inputPassword = passwordInput.value.trim();  
      if (!inputPassword) return alert("Enter the spin password");  
  
      const user = auth.currentUser;  
      if (!user) return alert("Please login first");  
  
      const userId = user.uid;  
      const userDoc = await db.collection("users").doc(userId).get();  
      if (!userDoc.exists) return alert("User not found");  
  
      const userData = userDoc.data();  
      const userName = userData.name || "Anonymous";  
      const currentBalance = userData.accountBalance || 0;  
  
      // Check password validity  
      const passwordSnapshot = await db.collection("spinPasswords")  
        .where("password", "==", inputPassword)  
        .get();  
      if (passwordSnapshot.empty) return message.textContent = "Invalid password.";  
  
      const passwordDoc = passwordSnapshot.docs[0];  
      const expiresAt = passwordDoc.data().expiresAt?.toDate();  
      if (!expiresAt || new Date() > expiresAt) {  
        return message.textContent = "This password has expired.";  
      }  
  
      // Check if user already spun  
      const alreadySpun = await db.collection("spins")  
        .where("userId", "==", userId)  
        .where("roundPassword", "==", inputPassword)  
        .get();  
      if (!alreadySpun.empty) {  
        return message.textContent = "You already spun in this round.";  
      }  
  
      // Limit to 10 winners  
      const winners = await db.collection("spins")  
        .where("roundPassword", "==", inputPassword)  
        .get();  
      if (winners.size >= 10) {  
        return message.textContent = "This round is full. Try next one.";  
      }  
  
      // Eligibility: either referral not awarded or active earnings  
      let eligible = false;  
      let referralDoc = null;  
  
      const referrals = await db.collection("referrals")  
        .where("referrerId", "==", userId)  
        .get();  
      for (const doc of referrals.docs) {  
        if (!doc.data().spinStatus) {  
          eligible = true;  
          referralDoc = doc;  
          break;  
        }  
      }  
  
      if (!eligible) {  
        const earnings = await db.collection("earnings")  
          .where("userId", "==", userId)  
          .get();  
        for (const doc of earnings.docs) {  
          if ((doc.data().remainingDays || 0) > 0) {  
            eligible = true;  
            break;  
          }  
        }  
      }  
  
      if (!eligible) {  
        return message.textContent = "You need active earnings or a valid referral to spin.";  
      }  
  
      // Spin animation and award  
      wheel.classList.add("spin");  
      setTimeout(async () => {  
        const amountWon = 500;  
  
        // Update referral as awarded  
        if (referralDoc) {  
          await referralDoc.ref.update({ spinStatus: "awarded" });  
        }  
  
        // Save spin  
        await db.collection("spins").add({  
          userId,  
          userName,  
          roundPassword: inputPassword,  
          amountWon,  
          timestamp: firebase.firestore.FieldValue.serverTimestamp()  
        });  
  
        // Update user balance  
        await db.collection("users").doc(userId).update({  
          accountBalance: currentBalance + amountWon  
        });  
  
        message.textContent = `ðŸŽ‰ You won ${amountWon} UGX!`;  
        loadWinners();  
      }, 1200);  
    }  
  
    async function loadWinners() {  
      const snapshot = await db.collection("spins").orderBy("timestamp", "desc").limit(10).get();  
      if (snapshot.empty) {  
        winnerList.innerHTML = "No winners yet.";  
        return;  
      }  
      winnerList.innerHTML = "";  
      snapshot.forEach(doc => {  
        const data = doc.data();  
        const time = data.timestamp?.toDate().toLocaleString() || "recently";  
        winnerList.innerHTML += `<p>ðŸŽ‰ ${data.userName} - 500 UGX on ${time}</p>`;  
      });  
    }  
  
    auth.onAuthStateChanged(user => {  
      if (user) loadWinners();  
      else window.location.href = "login.html";  
    });  
  </script>  </body>  
</html>  